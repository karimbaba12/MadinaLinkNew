<div class="payment-container">
    <mat-card class="payment-card">
        <mat-card-header class="payment-header">
            <mat-card-title>
                <mat-icon class="header-icon">payments</mat-icon>
                Payment Management
            </mat-card-title>
            <mat-card-subtitle>
                Process individual and bulk payments for subscriptions
            </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
            <!-- Pending Payments Section -->
            <section class="pending-payments-section py-4">
                <div class="section-header">
                    <div class="section-title">
                        <mat-icon class="section-icon">pending_actions</mat-icon>
                        <h2>Pending Payments</h2>
                    </div>
                    <div class="section-actions">
                        <button mat-flat-button color="primary" (click)="loadUsersToPay()">
                            <mat-icon>refresh</mat-icon>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="search-container">
                    <form [formGroup]="searchForm">
                        <mat-form-field appearance="outline" class="search-field w-100">
                            <mat-label>Search customers</mat-label>
                            <input matInput formControlName="searchTerm" (input)="searchUsers()"
                                placeholder="Search by name, email or phone">
                            <mat-icon matSuffix>search</mat-icon>
                            <button matSuffix mat-icon-button *ngIf="searchForm.get('searchTerm')?.value"
                                (click)="clearSearch()">
                                <mat-icon>close</mat-icon>
                            </button>
                        </mat-form-field>
                    </form>
                </div>

                <div class="payment-summary">
                    <div class="summary-card selected-count">
                        <mat-icon>group</mat-icon>
                        <div class="summary-content">
                            <span class="summary-label">Selected Users</span>
                            <span class="summary-value">{{ selectedUsers.length }}</span>
                        </div>
                    </div>
                    <div class="summary-card selected-amount">
                        <mat-icon>paid</mat-icon>
                        <div class="summary-content">
                            <span class="summary-label">Selected Amount</span>
                            <span class="summary-value">{{ selectedAmount | currency }}</span>
                        </div>
                    </div>
                </div>

                <div class="users-table-container" *ngIf="!isFetchingUsersToPay; else loading">
                    <div class="table-actions">
                        <button mat-flat-button color="primary"
                            [disabled]="selectedUsers.length === 0 || isProcessingPayment"
                            (click)="confirmBulkPayment()">
                            <mat-icon>payments</mat-icon>
                            Pay Selected ({{ selectedUsers.length }})
                            <mat-spinner *ngIf="isProcessingPayment" diameter="20"></mat-spinner>
                        </button>
                    </div>

                    <div class="table-wrapper">
                        <mat-table [dataSource]="filteredUsers" matSort class="mat-elevation-z1">
                            <!-- Select Column -->
                            <ng-container matColumnDef="select">
                                <mat-header-cell *matHeaderCellDef>
                                    <mat-checkbox [checked]="selectAllChecked" (change)="toggleSelectAll()">
                                    </mat-checkbox>
                                </mat-header-cell>
                                <mat-cell *matCellDef="let user">
                                    <mat-checkbox [checked]="isUserSelected(user)" (change)="toggleUserSelection(user)">
                                    </mat-checkbox>
                                </mat-cell>
                            </ng-container>

                            <!-- Name Column -->
                            <ng-container matColumnDef="name">
                                <mat-header-cell *matHeaderCellDef mat-sort-header>Customer</mat-header-cell>
                                <mat-cell *matCellDef="let user">
                                    <div class="user-info">
                                        <span class="user-name">{{ user.name }}</span>
                                        <span class="user-email">{{ user.email }}</span>
                                    </div>
                                </mat-cell>
                            </ng-container>

                            <!-- Amount Due Column -->
                            <ng-container matColumnDef="amountDue">
                                <mat-header-cell *matHeaderCellDef mat-sort-header>Amount Due</mat-header-cell>
                                <mat-cell *matCellDef="let user">
                                    <span class="amount-due">{{ user.amountDue | currency }}</span>
                                </mat-cell>
                            </ng-container>

                            <!-- Balance Column -->
                            <ng-container matColumnDef="balance">
                                <mat-header-cell *matHeaderCellDef mat-sort-header>Balance</mat-header-cell>
                                <mat-cell *matCellDef="let user">
                                    <span class="balance" [class.negative]="(user.balance || 0) < 0">
                                        {{ user.balance | currency }}
                                    </span>
                                </mat-cell>
                            </ng-container>

                            <!-- Actions Column -->
                            <ng-container matColumnDef="actions">
                                <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
                                <mat-cell *matCellDef="let user">
                                    <button mat-icon-button color="primary" matTooltip="View details and pay"
                                        (click)="selectUser(user)">
                                        <mat-icon>payment</mat-icon>
                                    </button>
                                </mat-cell>
                            </ng-container>

                            <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
                            <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
                        </mat-table>

                        <mat-paginator [length]="filteredUsers.length" [pageSize]="pageSize"
                            [pageSizeOptions]="pageSizeOptions" showFirstLastButtons aria-label="Select page of users">
                        </mat-paginator>
                    </div>

                    <div class="no-results" *ngIf="filteredUsers.length === 0 && !isSearching">
                        <mat-icon>sentiment_very_satisfied</mat-icon>
                        <p>No pending payments found</p>
                    </div>

                    <div class="no-results" *ngIf="filteredUsers.length === 0 && isSearching">
                        <mat-icon>search_off</mat-icon>
                        <p>No users found matching your search</p>
                    </div>
                </div>

                <ng-template #loading>
                    <div class="loading-container">
                        <mat-spinner diameter="50"></mat-spinner>
                        <p>Loading pending payments...</p>
                    </div>
                </ng-template>
            </section>

            <!-- In your payment.component.html -->
            <section class="user-cards-section" *ngIf="selectedUser">
                <div class="section-header">
                    <div class="section-title">
                        <mat-icon class="section-icon">person</mat-icon>
                        <h2>Payment for {{ selectedUser.name }}</h2>
                    </div>
                    <button mat-icon-button (click)="resetForm()" matTooltip="Close" class="close-button">
                        <mat-icon>close</mat-icon>
                    </button>
                </div>

                <div class="user-details-grid">
                    <!-- Customer Details Card -->
                    <mat-card class="user-card">
                        <mat-card-header>
                            <mat-card-title>
                                <mat-icon>account_circle</mat-icon>
                                Customer Details
                            </mat-card-title>
                        </mat-card-header>
                        <mat-card-content>
                            <div class="detail-item">
                                <mat-icon>person</mat-icon>
                                <span>{{ selectedUser.name }}</span>
                            </div>
                            <div class="detail-item">
                                <mat-icon>phone</mat-icon>
                                <span>{{ selectedUser.phoneNumber }}</span>
                            </div>
                            <div class="detail-item">
                                <mat-icon>email</mat-icon>
                                <span>{{ selectedUser.email || 'Not provided' }}</span>
                            </div>
                            <div class="detail-item balance">
                                <mat-icon>account_balance_wallet</mat-icon>
                                <span [class.negative]="(selectedUser.balance || 0) < 0">
                                    Balance: {{ selectedUser.balance | currency }}
                                </span>
                            </div>
                        </mat-card-content>
                    </mat-card>

                    <!-- Subscriptions Card -->
                    <mat-card class="subscriptions-card" *ngIf="selectedUser.subscriptions?.length">
                        <mat-card-header>
                            <mat-card-title>
                                <mat-icon>subscriptions</mat-icon>
                                Subscriptions ({{ selectedUser.subscriptions.length }})
                            </mat-card-title>
                        </mat-card-header>
                        <mat-card-content>
                            <div class="subscription-list">
                                <div class="subscription-item"
                                    *ngFor="let sub of selectedUser.subscriptions; let i = index">
                                    <div class="subscription-header">
                                        <mat-icon>widgets</mat-icon>
                                        <h3>{{ subServiceNames[sub.subServiceId ?? 0] }}</h3>
                                    </div>
                                    <div class="subscription-details">
                                        <div class="detail">
                                            <span class="label">Price:</span>
                                            <span class="value">{{ sub.price | currency }}</span>
                                        </div>
                                        <div class="detail">
                                            <span class="label">Quantity:</span>
                                            <span class="value">{{ sub.quantity }}</span>
                                        </div>
                                        <div class="detail">
                                            <span class="label">Period:</span>
                                            <span class="value">
                                                {{ getFormattedDate(sub.startDate ??0) }} -
                                                {{ getFormattedDate(sub.endDate ?? 0) }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </mat-card-content>
                    </mat-card>

                    <!-- Payment Form Card -->
                    <mat-card class="payment-form-card">
                        <mat-card-header>
                            <mat-card-title>
                                <mat-icon>payment</mat-icon>
                                Payment Details
                            </mat-card-title>
                        </mat-card-header>
                        <mat-card-content>
                            <form [formGroup]="paymentForm" class="payment-form">
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Amount</mat-label>
                                    <input matInput type="number" formControlName="amount" step="0.01" min="0.01">
                                    <span matPrefix class="px-2">$&nbsp;</span>
                                    <mat-error *ngIf="paymentForm.get('amount')?.invalid">
                                        Please enter a valid amount
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Payment Method</mat-label>
                                    <mat-select formControlName="paymentMethod">
                                        <mat-option value="cash">Cash</mat-option>
                                        <mat-option value="credit_card">Credit Card</mat-option>
                                        <mat-option value="bank_transfer">Bank Transfer</mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Notes</mat-label>
                                    <textarea matInput formControlName="notes" rows="3"></textarea>
                                </mat-form-field>

                                <div class="payment-summary">
                                    <div class="summary-item">
                                        <span>New Balance:</span>
                                        <span class="balance">
                                            {{ (selectedUser.balance || 0) - (paymentForm.value.amount || 0) | currency }}
                                        </span>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button mat-stroked-button color="warn" (click)="resetForm()">
                                        Cancel
                                    </button>
                                    <button mat-flat-button color="primary"
                                        [disabled]="paymentForm.invalid || isProcessingPayment"
                                        (click)="confirmPayment()">
                                        Process Payment
                                        <mat-spinner *ngIf="isProcessingPayment" diameter="20"></mat-spinner>
                                    </button>
                                </div>
                            </form>
                        </mat-card-content>
                    </mat-card>
                </div>
            </section>
        </mat-card-content>
    </mat-card>
</div>